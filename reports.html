<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics | Installment System</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.8.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.8.4/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.8.4/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <div class="logo-small">üìä</div>
                <div>
                    <h1>Reports & Analytics</h1>
                    <p class="admin-email" id="adminEmail">Loading...</p>
                </div>
            </div>
            
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link">
                    <span class="nav-icon">üìä</span>
                    Dashboard
                </a>
                <a href="add-customer.html" class="nav-link">
                    <span class="nav-icon">‚ûï</span>
                    Add Customer
                </a>
                <a href="view-customers.html" class="nav-link">
                    <span class="nav-icon">üë•</span>
                    View Customers
                </a>
                <a href="reports.html" class="nav-link active">
                    <span class="nav-icon">üìà</span>
                    Reports
                </a>
                <button id="logoutBtn" class="btn btn-logout">
                    <span class="nav-icon">üö™</span>
                    Logout
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h2>Business Analytics & Reports</h2>
                <p>Comprehensive insights into your installment business performance</p>
                <div class="report-period">
                    <span id="currentPeriod">Current Period: Loading...</span>
                </div>
            </div>
            
            <!-- Report Filters -->
            <div class="report-controls">
                <div class="filter-section">
                    <h3><span class="filter-icon">‚öôÔ∏è</span> Report Filters</h3>
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label for="reportType">Report Type</label>
                            <select id="reportType">
                                <option value="overview">Business Overview</option>
                                <option value="financial">Financial Report</option>
                                <option value="customers">Customer Analysis</option>
                                <option value="products">Product Analysis</option>
                                <option value="collections">Collections Report</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="timePeriod">Time Period</label>
                            <select id="timePeriod">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month" selected>This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        
                        <div class="filter-group" id="customDateRange" style="display: none;">
                            <label>Custom Range</label>
                            <div class="date-range">
                                <input type="date" id="dateFrom">
                                <span>to</span>
                                <input type="date" id="dateTo">
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label for="groupBy">Group By</label>
                            <select id="groupBy">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly" selected>Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-actions">
                        <button id="generateReport" class="btn btn-primary">
                            <span class="btn-icon">üìä</span>
                            Generate Report
                        </button>
                        <button id="resetFilters" class="btn btn-secondary">
                            <span class="btn-icon">‚Ü∫</span>
                            Reset Filters
                        </button>
                        <button id="exportReport" class="btn btn-success">
                            <span class="btn-icon">üì•</span>
                            Export Report
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Summary Stats -->
            <div class="stats-summary">
                <div class="stat-card-large">
                    <div class="stat-icon-large total-revenue">üí∞</div>
                    <div class="stat-content-large">
                        <h4>Total Revenue</h4>
                        <p id="totalRevenue" class="stat-value">‚Çπ0.00</p>
                        <p class="stat-change" id="revenueChange">+0% from last period</p>
                    </div>
                </div>
                
                <div class="stat-card-large">
                    <div class="stat-icon-large total-customers">üë•</div>
                    <div class="stat-content-large">
                        <h4>Total Customers</h4>
                        <p id="totalCustomers" class="stat-value">0</p>
                        <p class="stat-change" id="customerChange">+0 from last period</p>
                    </div>
                </div>
                
                <div class="stat-card-large">
                    <div class="stat-icon-large collections">üíµ</div>
                    <div class="stat-content-large">
                        <h4>Collections Rate</h4>
                        <p id="collectionRate" class="stat-value">0%</p>
                        <p class="stat-change" id="collectionChange">+0% from target</p>
                    </div>
                </div>
                
                <div class="stat-card-large">
                    <div class="stat-icon-large overdue">‚è∞</div>
                    <div class="stat-content-large">
                        <h4>Overdue Amount</h4>
                        <p id="overdueAmount" class="stat-value overdue">‚Çπ0.00</p>
                        <p class="stat-change" id="overdueChange">0 accounts</p>
                    </div>
                </div>
            </div>
            
            <!-- Charts Section -->
            <div class="charts-section">
                <div class="chart-row">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h4>Revenue Trend</h4>
                            <div class="chart-legend">
                                <span class="legend-item"><span class="legend-color revenue"></span>Revenue</span>
                                <span class="legend-item"><span class="legend-color collections"></span>Collections</span>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h4>Customer Status Distribution</h4>
                            <div class="chart-legend" id="statusLegend"></div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="chart-row">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h4>Product Category Performance</h4>
                            <select id="productMetric" class="chart-metric">
                                <option value="revenue">By Revenue</option>
                                <option value="count">By Count</option>
                                <option value="average">By Average Value</option>
                            </select>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="productChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h4>Monthly Collections</h4>
                            <div class="chart-legend">
                                <span class="legend-item"><span class="legend-color target"></span>Target</span>
                                <span class="legend-item"><span class="legend-color actual"></span>Actual</span>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="collectionsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Reports -->
            <div class="detailed-reports">
                <div class="reports-header">
                    <h3>Detailed Reports</h3>
                    <div class="report-tabs">
                        <button class="report-tab active" data-report="payments">Payment Report</button>
                        <button class="report-tab" data-report="customers">Customer Report</button>
                        <button class="report-tab" data-report="products">Product Report</button>
                        <button class="report-tab" data-report="overdue">Overdue Report</button>
                    </div>
                </div>
                
                <div class="report-content active" id="payments-report">
                    <div class="table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Product</th>
                                    <th>Amount Due</th>
                                    <th>Amount Paid</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>Due Date</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody">
                                <tr>
                                    <td colspan="8" class="loading-cell">Loading payment data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="report-content" id="customers-report">
                    <div class="table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Customer ID</th>
                                    <th>Name</th>
                                    <th>Join Date</th>
                                    <th>Total Purchases</th>
                                    <th>Total Paid</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>Last Payment</th>
                                </tr>
                            </thead>
                            <tbody id="customersTableBody">
                                <tr>
                                    <td colspan="8" class="loading-cell">Loading customer data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="report-content" id="products-report">
                    <div class="table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Product Category</th>
                                    <th>Product Name</th>
                                    <th>Total Sold</th>
                                    <th>Total Revenue</th>
                                    <th>Avg. Price</th>
                                    <th>Avg. Installment</th>
                                    <th>Completion Rate</th>
                                    <th>Top Customer</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <tr>
                                    <td colspan="8" class="loading-cell">Loading product data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="report-content" id="overdue-report">
                    <div class="table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Phone</th>
                                    <th>Product</th>
                                    <th>Total Due</th>
                                    <th>Overdue Amount</th>
                                    <th>Due Date</th>
                                    <th>Days Overdue</th>
                                    <th>Last Contact</th>
                                </tr>
                            </thead>
                            <tbody id="overdueTableBody">
                                <tr>
                                    <td colspan="8" class="loading-cell">Loading overdue data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Insights & Recommendations -->
            <div class="insights-section">
                <h3><span class="insight-icon">üí°</span> Business Insights</h3>
                <div class="insights-grid" id="insightsContainer">
                    <div class="insight-card">
                        <div class="insight-icon positive">üìà</div>
                        <div class="insight-content">
                            <h4>Performance Summary</h4>
                            <p>Loading business insights...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Export Options -->
            <div class="export-section">
                <h3><span class="export-icon">üì§</span> Export Options</h3>
                <div class="export-grid">
                    <button class="export-option" onclick="exportData('pdf')">
                        <span class="export-icon">üìÑ</span>
                        <span>Export as PDF</span>
                        <small>Complete report with charts</small>
                    </button>
                    
                    <button class="export-option" onclick="exportData('excel')">
                        <span class="export-icon">üìä</span>
                        <span>Export as Excel</span>
                        <small>Detailed data in spreadsheet</small>
                    </button>
                    
                    <button class="export-option" onclick="exportData('csv')">
                        <span class="export-icon">üìù</span>
                        <span>Export as CSV</span>
                        <small>Raw data for analysis</small>
                    </button>
                    
                    <button class="export-option" onclick="window.print()">
                        <span class="export-icon">üñ®Ô∏è</span>
                        <span>Print Report</span>
                        <small>Printer-friendly version</small>
                    </button>
                </div>
            </div>
            
            <!-- Message Box -->
            <div id="reportMessage" class="message-box"></div>
        </div>
    </main>
    
    <script src="script.js"></script>
    <script>
        // Charts instances
        let revenueChart = null;
        let statusChart = null;
        let productChart = null;
        let collectionsChart = null;
        
        // Report data
        let reportData = {
            customers: [],
            payments: [],
            products: [],
            overdue: []
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            setupEventListeners();
            loadReportData();
        });
        
        function initializePage() {
            // Check authentication
            firebase.auth().onAuthStateChanged((user) => {
                if (!user) {
                    window.location.href = 'index.html';
                } else {
                    document.getElementById('adminEmail').textContent = user.email;
                    updateCurrentPeriod();
                }
            });
            
            // Set default dates for custom range
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('dateFrom').value = firstDay.toISOString().split('T')[0];
            document.getElementById('dateTo').value = today.toISOString().split('T')[0];
        }
        
        function setupEventListeners() {
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                firebase.auth().signOut().then(() => {
                    window.location.href = 'index.html';
                });
            });
            
            // Generate report
            document.getElementById('generateReport').addEventListener('click', loadReportData);
            
            // Reset filters
            document.getElementById('resetFilters').addEventListener('click', resetFilters);
            
            // Export report
            document.getElementById('exportReport').addEventListener('click', exportCurrentReport);
            
            // Time period change
            document.getElementById('timePeriod').addEventListener('change', function() {
                const customRange = document.getElementById('customDateRange');
                customRange.style.display = this.value === 'custom' ? 'block' : 'none';
            });
            
            // Report tabs
            document.querySelectorAll('.report-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const reportType = this.getAttribute('data-report');
                    
                    // Update active tab
                    document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding content
                    document.querySelectorAll('.report-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(reportType + '-report').classList.add('active');
                });
            });
            
            // Product metric change
            document.getElementById('productMetric').addEventListener('change', updateProductChart);
        }
        
        function updateCurrentPeriod() {
            const periodSelect = document.getElementById('timePeriod');
            const period = periodSelect.options[periodSelect.selectedIndex].text;
            document.getElementById('currentPeriod').textContent = `Current Period: ${period}`;
        }
        
        async function loadReportData() {
            const messageBox = document.getElementById('reportMessage');
            messageBox.innerHTML = '<div class="message info">Loading report data... Please wait</div>';
            
            try {
                // Load all customer data
                const db = firebase.firestore();
                const snapshot = await db.collection('customers').get();
                
                if (snapshot.empty) {
                    showNoDataMessage();
                    return;
                }
                
                // Process data
                reportData.customers = [];
                reportData.payments = [];
                reportData.products = [];
                reportData.overdue = [];
                
                snapshot.forEach(doc => {
                    const customer = {
                        id: doc.id,
                        ...doc.data()
                    };
                    reportData.customers.push(customer);
                    
                    // Add to payments
                    reportData.payments.push({
                        date: customer.createdAt,
                        customer: customer.name,
                        product: customer.productName,
                        totalAmount: parseFloat(customer.totalAmount) || 0,
                        paidAmount: parseFloat(customer.paidAmount) || 0,
                        balance: (parseFloat(customer.totalAmount) || 0) - (parseFloat(customer.paidAmount) || 0),
                        status: customer.status || 'Active',
                        dueDate: customer.dueDate
                    });
                    
                    // Add to products
                    reportData.products.push({
                        category: customer.productCategory,
                        name: customer.productName,
                        amount: parseFloat(customer.totalAmount) || 0,
                        installment: parseFloat(customer.installmentAmount) || 0
                    });
                    
                    // Check if overdue
                    if (customer.dueDate) {
                        const dueDate = new Date(customer.dueDate);
                        const today = new Date();
                        if (dueDate < today && customer.status !== 'Completed') {
                            reportData.overdue.push({
                                customer: customer.name,
                                phone: customer.phone,
                                product: customer.productName,
                                totalDue: parseFloat(customer.totalAmount) || 0,
                                overdueAmount: (parseFloat(customer.totalAmount) || 0) - (parseFloat(customer.paidAmount) || 0),
                                dueDate: customer.dueDate,
                                daysOverdue: Math.floor((today - dueDate) / (1000 * 60 * 60 * 24))
                            });
                        }
                    }
                });
                
                // Update UI
                updateSummaryStats();
                updateCharts();
                updateDetailedReports();
                updateInsights();
                
                messageBox.innerHTML = '<div class="message success">‚úÖ Report generated successfully</div>';
                
            } catch (error) {
                console.error('Report error:', error);
                messageBox.innerHTML = `<div class="message error">‚ùå Error generating report: ${error.message}</div>`;
            }
        }
        
        function updateSummaryStats() {
            const customers = reportData.customers;
            
            if (customers.length === 0) {
                document.getElementById('totalRevenue').textContent = '‚Çπ0.00';
                document.getElementById('totalCustomers').textContent = '0';
                document.getElementById('collectionRate').textContent = '0%';
                document.getElementById('overdueAmount').textContent = '‚Çπ0.00';
                return;
            }
            
            // Calculate totals
            let totalRevenue = 0;
            let totalPaid = 0;
            let overdueAmount = 0;
            
            customers.forEach(customer => {
                totalRevenue += parseFloat(customer.totalAmount) || 0;
                totalPaid += parseFloat(customer.paidAmount) || 0;
                
                // Check if overdue
                if (customer.dueDate) {
                    const dueDate = new Date(customer.dueDate);
                    const today = new Date();
                    if (dueDate < today && customer.status !== 'Completed') {
                        overdueAmount += (parseFloat(customer.totalAmount) || 0) - (parseFloat(customer.paidAmount) || 0);
                    }
                }
            });
            
            const collectionRate = totalRevenue > 0 ? (totalPaid / totalRevenue * 100) : 0;
            
            // Update display
            document.getElementById('totalRevenue').textContent = '‚Çπ' + totalRevenue.toFixed(2);
            document.getElementById('totalCustomers').textContent = customers.length;
            document.getElementById('collectionRate').textContent = collectionRate.toFixed(1) + '%';
            document.getElementById('overdueAmount').textContent = '‚Çπ' + overdueAmount.toFixed(2);
            
            // Calculate changes (simulated for demo)
            document.getElementById('revenueChange').textContent = '+12.5% from last month';
            document.getElementById('customerChange').textContent = `+${Math.floor(customers.length * 0.1)} from last month`;
            document.getElementById('collectionChange').textContent = '+3.2% from target';
            document.getElementById('overdueChange').textContent = `${reportData.overdue.length} accounts`;
        }
        
        function updateCharts() {
            updateRevenueChart();
            updateStatusChart();
            updateProductChart();
            updateCollectionsChart();
        }
        
        function updateRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Destroy existing chart
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            // Sample data - in real app, group by month
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'];
            const revenueData = [120000, 180000, 150000, 220000, 190000, 250000, 210000];
            const collectionsData = [80000, 120000, 110000, 150000, 140000, 180000, 160000];
            
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Revenue',
                            data: revenueData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Collections',
                            data: collectionsData,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + value.toLocaleString('en-IN');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if (statusChart) {
                statusChart.destroy();
            }
            
            // Calculate status distribution
            const statusCounts = {
                active: 0,
                completed: 0,
                overdue: 0,
                pending: 0
            };
            
            reportData.customers.forEach(customer => {
                const status = (customer.status || 'active').toLowerCase();
                if (statusCounts.hasOwnProperty(status)) {
                    statusCounts[status]++;
                } else {
                    statusCounts.active++;
                }
            });
            
            // Update legend
            const legend = document.getElementById('statusLegend');
            legend.innerHTML = '';
            
            for (const [status, count] of Object.entries(statusCounts)) {
                if (count > 0) {
                    const color = getStatusColor(status);
                    legend.innerHTML += `
                        <span class="legend-item">
                            <span class="legend-color" style="background: ${color}"></span>
                            ${status.charAt(0).toUpperCase() + status.slice(1)}: ${count}
                        </span>
                    `;
                }
            }
            
            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Active', 'Completed', 'Overdue', 'Pending'],
                    datasets: [{
                        data: [statusCounts.active, statusCounts.completed, statusCounts.overdue, statusCounts.pending],
                        backgroundColor: [
                            getStatusColor('active'),
                            getStatusColor('completed'),
                            getStatusColor('overdue'),
                            getStatusColor('pending')
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        function updateProductChart() {
            const ctx = document.getElementById('productChart').getContext('2d');
            const metric = document.getElementById('productMetric').value;
            
            if (productChart) {
                productChart.destroy();
            }
            
            // Group products by category
            const categories = {};
            reportData.products.forEach(product => {
                const category = product.category || 'Other';
                if (!categories[category]) {
                    categories[category] = {
                        count: 0,
                        totalAmount: 0
                    };
                }
                categories[category].count++;
                categories[category].totalAmount += product.amount;
            });
            
            const categoryNames = Object.keys(categories);
            let chartData = [];
            let label = '';
            
            switch(metric) {
                case 'revenue':
                    chartData = categoryNames.map(cat => categories[cat].totalAmount);
                    label = 'Revenue (‚Çπ)';
                    break;
                case 'count':
                    chartData = categoryNames.map(cat => categories[cat].count);
                    label = 'Number of Sales';
                    break;
                case 'average':
                    chartData = categoryNames.map(cat => categories[cat].totalAmount / categories[cat].count);
                    label = 'Average Value (‚Çπ)';
                    break;
            }
            
            productChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categoryNames,
                    datasets: [{
                        label: label,
                        data: chartData,
                        backgroundColor: categoryNames.map((_, i) => 
                            `hsl(${(i * 60) % 360}, 70%, 60%)`
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (metric === 'revenue' || metric === 'average') {
                                        return '‚Çπ' + value.toLocaleString('en-IN');
                                    }
                                        return value;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateCollectionsChart() {
            const ctx = document.getElementById('collectionsChart').getContext('2d');
            
            if (collectionsChart) {
                collectionsChart.destroy();
            }
            
            // Sample data
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            const targetData = [180000, 190000, 200000, 210000, 220000, 230000];
            const actualData = [165000, 185000, 195000, 205000, 215000, 225000];
            
            collectionsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Target',
                            data: targetData,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 1
                        },
                        {
                            label: 'Actual',
                            data: actualData,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgb(54, 162, 235)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + value.toLocaleString('en-IN');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateDetailedReports() {
            updatePaymentsTable();
            updateCustomersTable();
            updateProductsTable();
            updateOverdueTable();
        }
        
        function updatePaymentsTable() {
            const tbody = document.getElementById('paymentsTableBody');
            
            if (reportData.payments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-cell">No payment data available</td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            reportData.payments.slice(0, 10).forEach(payment => {
                const date = payment.date ? new Date(payment.date).toLocaleDateString('en-IN') : 'N/A';
                const dueDate = payment.dueDate ? new Date(payment.dueDate).toLocaleDateString('en-IN') : 'N/A';
                const statusClass = payment.status.toLowerCase();
                
                html += `
                    <tr>
                        <td>${date}</td>
                        <td>${payment.customer || 'N/A'}</td>
                        <td>${payment.product || 'N/A'}</td>
                        <td>‚Çπ${payment.totalAmount.toFixed(2)}</td>
                        <td>‚Çπ${payment.paidAmount.toFixed(2)}</td>
                        <td class="${payment.balance > 0 ? 'due-amount' : ''}">
                            ‚Çπ${payment.balance.toFixed(2)}
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                ${payment.status}
                            </span>
                        </td>
                        <td class="${isOverdue(payment.dueDate) ? 'overdue-date' : ''}">
                            ${dueDate}
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        function updateCustomersTable() {
            const tbody = document.getElementById('customersTableBody');
            
            if (reportData.customers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-cell">No customer data available</td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            reportData.customers.slice(0, 10).forEach(customer => {
                const joinDate = customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('en-IN') : 'N/A';
                const totalAmount = parseFloat(customer.totalAmount) || 0;
                const paidAmount = parseFloat(customer.paidAmount) || 0;
                const balance = totalAmount - paidAmount;
                
                html += `
                    <tr>
                        <td>${customer.customerID || 'N/A'}</td>
                        <td>${customer.name || 'N/A'}</td>
                        <td>${joinDate}</td>
                        <td>‚Çπ${totalAmount.toFixed(2)}</td>
                        <td>‚Çπ${paidAmount.toFixed(2)}</td>
                        <td class="${balance > 0 ? 'due-amount' : ''}">
                            ‚Çπ${balance.toFixed(2)}
                        </td>
                        <td>
                            <span class="status-badge ${customer.status?.toLowerCase() || 'active'}">
                                ${customer.status || 'Active'}
                            </span>
                        </td>
                        <td>
                            ${customer.dueDate ? new Date(customer.dueDate).toLocaleDateString('en-IN') : 'N/A'}
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        function updateProductsTable() {
            const tbody = document.getElementById('productsTableBody');
            
            if (reportData.products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-cell">No product data available</td>
                    </tr>
                `;
                return;
            }
            
            // Group products
            const productStats = {};
            reportData.products.forEach(product => {
                const key = product.category + '|' + product.name;
                if (!productStats[key]) {
                    productStats[key] = {
                        category: product.category || 'Other',
                        name: product.name || 'Unknown',
                        count: 0,
                        totalRevenue: 0,
                        totalInstallment: 0
                    };
                }
                productStats[key].count++;
                productStats[key].totalRevenue += product.amount;
                productStats[key].totalInstallment += product.installment;
            });
            
            let html = '';
            Object.values(productStats).slice(0, 10).forEach(stat => {
                const avgPrice = stat.count > 0 ? stat.totalRevenue / stat.count : 0;
                const avgInstallment = stat.count > 0 ? stat.totalInstallment / stat.count : 0;
                
                html += `
                    <tr>
                        <td>${stat.category}</td>
                        <td>${stat.name}</td>
                        <td>${stat.count}</td>
                        <td>‚Çπ${stat.totalRevenue.toFixed(2)}</td>
                        <td>‚Çπ${avgPrice.toFixed(2)}</td>
                        <td>‚Çπ${avgInstallment.toFixed(2)}</td>
                        <td>
                            <div class="completion-rate">
                                <div class="progress-bar-small">
                                    <div class="progress-fill" style="width: 75%"></div>
                                </div>
                                <span>75%</span>
                            </div>
                        </td>
                        <td>Top Buyer</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        function updateOverdueTable() {
            const tbody = document.getElementById('overdueTableBody');
            
            if (reportData.overdue.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-cell">No overdue accounts</td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            reportData.overdue.forEach(item => {
                const daysClass = item.daysOverdue > 30 ? 'critical' : item.daysOverdue > 15 ? 'warning' : '';
                
                html += `
                    <tr>
                        <td>${item.customer || 'N/A'}</td>
                        <td>${item.phone || 'N/A'}</td>
                        <td>${item.product || 'N/A'}</td>
                        <td>‚Çπ${item.totalDue.toFixed(2)}</td>
                        <td class="overdue-amount">‚Çπ${item.overdueAmount.toFixed(2)}</td>
                        <td class="overdue-date">
                            ${item.dueDate ? new Date(item.dueDate).toLocaleDateString('en-IN') : 'N/A'}
                        </td>
                        <td class="${daysClass}">
                            ${item.daysOverdue} days
                        </td>
                        <td>
                            <button class="btn-action contact" onclick="contactCustomer('${item.customer}', '${item.phone}')">
                                üìû Contact
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        function updateInsights() {
            const container = document.getElementById('insightsContainer');
            const customers = reportData.customers;
            
            if (customers.length === 0) {
                container.innerHTML = `
                    <div class="insight-card">
                        <div class="insight-icon info">‚ÑπÔ∏è</div>
                        <div class="insight-content">
                            <h4>No Data Available</h4>
                            <p>Add customers to generate business insights</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Calculate insights
            const totalRevenue = customers.reduce((sum, c) => sum + (parseFloat(c.totalAmount) || 0), 0);
            const avgTransaction = totalRevenue / customers.length;
            const overdueCount = reportData.overdue.length;
            const collectionRate = totalRevenue > 0 ? 
                (customers.reduce((sum, c) => sum + (parseFloat(c.paidAmount) || 0), 0) / totalRevenue * 100) : 0;
            
            const insights = [
                {
                    icon: 'üìà',
                    type: 'positive',
                    title: 'Business Performance',
                    content: `Average transaction value is ‚Çπ${avgTransaction.toFixed(2)}. Collection rate is ${collectionRate.toFixed(1)}%.`
                },
                {
                    icon: 'üë•',
                    type: customers.length > 10 ? 'positive' : 'warning',
                    title: 'Customer Base',
                    content: `You have ${customers.length} active customers. ${customers.length > 10 ? 'Great growth!' : 'Consider expanding your customer base.'}`
                },
                {
                    icon: '‚è∞',
                    type: overdueCount > 5 ? 'warning' : 'positive',
                    title: 'Collections Health',
                    content: `${overdueCount} accounts are overdue. ${overdueCount > 5 ? 'Focus on collections.' : 'Collections are healthy.'}`
                },
                {
                    icon: 'üí∞',
                    type: 'info',
                    title: 'Revenue Insights',
                    content: `Monthly revenue potential: ‚Çπ${(totalRevenue / 6).toFixed(2)}. Target ‚Çπ${(totalRevenue * 1.2 / 6).toFixed(2)} next month.`
                }
            ];
            
            let html = '';
            insights.forEach(insight => {
                html += `
                    <div class="insight-card">
                        <div class="insight-icon ${insight.type}">${insight.icon}</div>
                        <div class="insight-content">
                            <h4>${insight.title}</h4>
                            <p>${insight.content}</p>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function resetFilters() {
            document.getElementById('reportType').value = 'overview';
            document.getElementById('timePeriod').value = 'month';
            document.getElementById('groupBy').value = 'monthly';
            document.getElementById('customDateRange').style.display = 'none';
            
            updateCurrentPeriod();
            loadReportData();
        }
        
        function exportCurrentReport() {
            const reportType = document.getElementById('reportType').value;
            const period = document.getElementById('timePeriod').value;
            
            alert(`Exporting ${reportType} report for ${period} period.\n\nThis feature will generate a comprehensive report file.`);
            
            // In a real implementation, this would generate and download the report
            document.getElementById('reportMessage').innerHTML = `
                <div class="message success">
                    ‚úÖ Report export started. Your file will download shortly.
                </div>
            `;
        }
        
        function showNoDataMessage() {
            document.getElementById('totalRevenue').textContent = '‚Çπ0.00';
            document.getElementById('totalCustomers').textContent = '0';
            document.getElementById('collectionRate').textContent = '0%';
            document.getElementById('overdueAmount').textContent = '‚Çπ0.00';
            
            document.getElementById('reportMessage').innerHTML = `
                <div class="message info">
                    ‚ÑπÔ∏è No customer data found. Add customers to generate reports.
                </div>
            `;
        }
        
        // Helper functions
        function getStatusColor(status) {
            const colors = {
                active: '#4CAF50',
                completed: '#2196F3',
                overdue: '#F44336',
                pending: '#FF9800'
            };
            return colors[status] || '#9E9E9E';
        }
        
        function isOverdue(dateString) {
            if (!dateString) return false;
            const dueDate = new Date(dateString);
            const today = new Date();
            return dueDate < today;
        }
        
        window.contactCustomer = function(customerName, phone) {
            alert(`Contact ${customerName} at ${phone}\n\nThis feature can be extended to make calls or send messages.`);
        };
        
        window.exportData = function(format) {
            alert(`Exporting data as ${format.toUpperCase()}.\n\nThis feature will generate a ${format} file with all report data.`);
        };
    </script>
</body>
</html>
