<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Customers | Installment System</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.8.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.8.4/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.8.4/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <div class="logo-small">üë•</div>
                <div>
                    <h1>View Customers</h1>
                    <p class="admin-email" id="adminEmail">Loading...</p>
                </div>
            </div>
            
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link">
                    <span class="nav-icon">üìä</span>
                    Dashboard
                </a>
                <a href="add-customer.html" class="nav-link">
                    <span class="nav-icon">‚ûï</span>
                    Add Customer
                </a>
                <a href="view-customers.html" class="nav-link active">
                    <span class="nav-icon">üîç</span>
                    View Customers
                </a>
                <a href="reports.html" class="nav-link">
                    <span class="nav-icon">üìà</span>
                    Reports
                </a>
                <button id="logoutBtn" class="btn btn-logout">
                    <span class="nav-icon">üö™</span>
                    Logout
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h2>Customer Database</h2>
                <p>Search, view, and manage all installment customers</p>
                <div class="header-stats">
                    <span>Total: <strong id="totalCount">0</strong> customers</span>
                    <span>Active: <strong id="activeCount">0</strong></span>
                    <span>Overdue: <strong id="overdueCount">0</strong></span>
                </div>
            </div>
            
            <!-- SEARCH ENGINE -->
            <div class="search-engine-container">
                <div class="search-header">
                    <h3><span class="search-icon">üîç</span> Advanced Search Engine</h3>
                    <p>Search customers by multiple criteria</p>
                </div>
                
                <div class="search-filters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="searchID">Customer ID</label>
                            <input type="text" id="searchID" placeholder="e.g., C001, A123">
                        </div>
                        
                        <div class="filter-group">
                            <label for="searchName">Customer Name</label>
                            <input type="text" id="searchName" placeholder="Enter full or partial name">
                        </div>
                        
                        <div class="filter-group">
                            <label for="searchPhone">Phone Number</label>
                            <input type="tel" id="searchPhone" placeholder="10-digit phone number">
                        </div>
                    </div>
                    
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="searchProduct">Product Name</label>
                            <input type="text" id="searchProduct" placeholder="Search by product">
                        </div>
                        
                        <div class="filter-group">
                            <label for="searchStatus">Account Status</label>
                            <select id="searchStatus">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Completed">Completed</option>
                                <option value="Overdue">Overdue</option>
                                <option value="Pending">Pending</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="searchDate">Date Range</label>
                            <input type="date" id="searchDate">
                        </div>
                    </div>
                    
                    <div class="search-actions">
                        <button id="searchButton" class="btn btn-primary">
                            <span class="btn-icon">üîç</span>
                            Search Customers
                        </button>
                        <button id="clearSearch" class="btn btn-secondary">
                            <span class="btn-icon">‚Ü∫</span>
                            Clear Filters
                        </button>
                        <button id="advancedSearch" class="btn btn-outline">
                            <span class="btn-icon">‚öôÔ∏è</span>
                            Advanced Options
                        </button>
                    </div>
                </div>
                
                <div class="search-results-info">
                    <span id="resultsCount">0 results found</span>
                    <span id="searchTime">Search time: 0s</span>
                </div>
            </div>
            
            <!-- Customers Table -->
            <div class="table-container-large">
                <div class="table-header">
                    <h3>Customer Records</h3>
                    <div class="table-actions">
                        <button id="refreshTable" class="btn btn-secondary btn-small">
                            <span class="btn-icon">üîÑ</span>
                            Refresh
                        </button>
                        <button id="exportCSV" class="btn btn-secondary btn-small">
                            <span class="btn-icon">üìä</span>
                            Export CSV
                        </button>
                        <button id="bulkPDF" class="btn btn-primary btn-small">
                            <span class="btn-icon">üì•</span>
                            Bulk PDF
                        </button>
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table id="customersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Customer</th>
                                <th>Contact</th>
                                <th>Product</th>
                                <th>Amount</th>
                                <th>Payment</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <tr>
                                <td colspan="9" class="loading-cell">
                                    <div class="loading-spinner"></div>
                                    <p>Loading customer data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="table-footer">
                    <div class="pagination">
                        <button id="prevPage" class="btn btn-outline btn-small" disabled>
                            ‚Üê Previous
                        </button>
                        <span id="pageInfo">Page 1 of 1</span>
                        <button id="nextPage" class="btn btn-outline btn-small" disabled>
                            Next ‚Üí
                        </button>
                    </div>
                    <div class="table-stats">
                        <span>Showing <strong id="showingCount">0</strong> of <strong id="totalRecords">0</strong> records</span>
                    </div>
                </div>
            </div>
            
            <!-- Customer Details Modal (Hidden by default) -->
            <div id="customerModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Customer Details</h3>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div class="modal-body" id="customerDetails">
                        <!-- Details will be loaded here -->
                    </div>
                    <div class="modal-footer">
                        <button id="printPDF" class="btn btn-primary">
                            <span class="btn-icon">üñ®Ô∏è</span>
                            Print PDF
                        </button>
                        <button id="editCustomer" class="btn btn-secondary">
                            <span class="btn-icon">‚úèÔ∏è</span>
                            Edit Customer
                        </button>
                        <button class="btn btn-outline close-modal">
                            Close
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Message Box -->
            <div id="tableMessage" class="message-box"></div>
        </div>
    </main>
    
    <script src="firebase-config.js"></script>
    <script>
        // Global variables
        let allCustomers = [];
        let filteredCustomers = [];
        let currentPage = 1;
        const recordsPerPage = 10;
        let currentCustomerID = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize
            initializePage();
            loadCustomers();
            
            // Event listeners
            setupEventListeners();
        });
        
        function initializePage() {
            // Check authentication
            firebase.auth().onAuthStateChanged((user) => {
                if (!user) {
                    window.location.href = 'index.html';
                } else {
                    document.getElementById('adminEmail').textContent = user.email;
                }
            });
        }
        
        function setupEventListeners() {
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                firebase.auth().signOut().then(() => {
                    window.location.href = 'index.html';
                });
            });
            
            // Search button
            document.getElementById('searchButton').addEventListener('click', performSearch);
            
            // Clear search
            document.getElementById('clearSearch').addEventListener('click', clearSearch);
            
            // Refresh table
            document.getElementById('refreshTable').addEventListener('click', loadCustomers);
            
            // Export CSV
            document.getElementById('exportCSV').addEventListener('click', exportToCSV);
            
            // Bulk PDF
            document.getElementById('bulkPDF').addEventListener('click', generateBulkPDF);
            
            // Pagination
            document.getElementById('prevPage').addEventListener('click', previousPage);
            document.getElementById('nextPage').addEventListener('click', nextPage);
            
            // Search on Enter key
            document.getElementById('searchName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            
            // Modal close
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', closeModal);
            });
            
            // Print PDF
            document.getElementById('printPDF').addEventListener('click', generateCustomerPDF);
            
            // Edit customer
            document.getElementById('editCustomer').addEventListener('click', editCustomer);
        }
        
        async function loadCustomers() {
            const tableBody = document.getElementById('customersTableBody');
            const messageBox = document.getElementById('tableMessage');
            
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="loading-cell">
                        <div class="loading-spinner"></div>
                        <p>Loading customer data...</p>
                    </td>
                </tr>
            `;
            
            messageBox.innerHTML = '';
            
            try {
                const startTime = Date.now();
                const db = firebase.firestore();
                const snapshot = await db.collection('customers').orderBy('createdAt', 'desc').get();
                
                allCustomers = [];
                let activeCount = 0;
                let overdueCount = 0;
                
                snapshot.forEach(doc => {
                    const customer = {
                        id: doc.id,
                        ...doc.data()
                    };
                    allCustomers.push(customer);
                    
                    // Count status
                    if (customer.status === 'Active') activeCount++;
                    if (customer.status === 'Overdue') overdueCount++;
                    
                    // Check if overdue
                    if (!customer.overdueChecked && customer.dueDate) {
                        const dueDate = new Date(customer.dueDate);
                        const today = new Date();
                        if (dueDate < today && customer.status === 'Active') {
                            customer.status = 'Overdue';
                            overdueCount++;
                        }
                    }
                });
                
                filteredCustomers = [...allCustomers];
                const endTime = Date.now();
                const searchTime = ((endTime - startTime) / 1000).toFixed(2);
                
                // Update counts
                document.getElementById('totalCount').textContent = allCustomers.length;
                document.getElementById('activeCount').textContent = activeCount;
                document.getElementById('overdueCount').textContent = overdueCount;
                document.getElementById('searchTime').textContent = `Loaded in ${searchTime}s`;
                
                // Display
                displayCustomers();
                updatePagination();
                
                messageBox.innerHTML = `
                    <div class="message success">
                        ‚úÖ Loaded ${allCustomers.length} customers successfully
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading customers:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="error-cell">
                            <div class="error-message">
                                ‚ùå Error loading data: ${error.message}
                            </div>
                        </td>
                    </tr>
                `;
                
                messageBox.innerHTML = `
                    <div class="message error">
                        ‚ùå Failed to load customers: ${error.message}
                    </div>
                `;
            }
        }
        
        function performSearch() {
            const searchStartTime = Date.now();
            
            const searchID = document.getElementById('searchID').value.trim().toUpperCase();
            const searchName = document.getElementById('searchName').value.trim().toLowerCase();
            const searchPhone = document.getElementById('searchPhone').value.trim();
            const searchProduct = document.getElementById('searchProduct').value.trim().toLowerCase();
            const searchStatus = document.getElementById('searchStatus').value;
            const searchDate = document.getElementById('searchDate').value;
            
            filteredCustomers = allCustomers.filter(customer => {
                let match = true;
                
                // Search by ID
                if (searchID && match) {
                    const customerID = customer.customerID || '';
                    match = customerID.includes(searchID);
                }
                
                // Search by name
                if (searchName && match) {
                    const customerName = (customer.name || '').toLowerCase();
                    match = customerName.includes(searchName);
                }
                
                // Search by phone
                if (searchPhone && match) {
                    const customerPhone = customer.phone || '';
                    match = customerPhone.includes(searchPhone);
                }
                
                // Search by product
                if (searchProduct && match) {
                    const productName = (customer.productName || '').toLowerCase();
                    match = productName.includes(searchProduct);
                }
                
                // Search by status
                if (searchStatus && match) {
                    match = customer.status === searchStatus;
                }
                
                // Search by date
                if (searchDate && match) {
                    const customerDate = customer.createdAt ? 
                        new Date(customer.createdAt).toISOString().split('T')[0] : '';
                    match = customerDate === searchDate;
                }
                
                return match;
            });
            
            const searchEndTime = Date.now();
            const searchTime = ((searchEndTime - searchStartTime) / 1000).toFixed(3);
            
            currentPage = 1;
            displayCustomers();
            updatePagination();
            
            document.getElementById('resultsCount').textContent = 
                `${filteredCustomers.length} results found`;
            document.getElementById('searchTime').textContent = `Search time: ${searchTime}s`;
        }
        
        function clearSearch() {
            document.getElementById('searchID').value = '';
            document.getElementById('searchName').value = '';
            document.getElementById('searchPhone').value = '';
            document.getElementById('searchProduct').value = '';
            document.getElementById('searchStatus').value = '';
            document.getElementById('searchDate').value = '';
            
            filteredCustomers = [...allCustomers];
            currentPage = 1;
            displayCustomers();
            updatePagination();
            
            document.getElementById('resultsCount').textContent = `${allCustomers.length} results found`;
            document.getElementById('searchTime').textContent = 'Search time: 0s';
        }
        
        function displayCustomers() {
            const tableBody = document.getElementById('customersTableBody');
            
            if (filteredCustomers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-cell">
                            <div class="empty-state">
                                <p>No customers found matching your search criteria.</p>
                                <button onclick="clearSearch()" class="btn btn-primary">
                                    Clear Search
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                
                document.getElementById('showingCount').textContent = '0';
                document.getElementById('totalRecords').textContent = '0';
                return;
            }
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = Math.min(startIndex + recordsPerPage, filteredCustomers.length);
            const pageCustomers = filteredCustomers.slice(startIndex, endIndex);
            
            let tableHTML = '';
            
            pageCustomers.forEach((customer, index) => {
                const serialNo = startIndex + index + 1;
                const totalAmount = parseFloat(customer.totalAmount) || 0;
                const paidAmount = parseFloat(customer.paidAmount) || 0;
                const remainingAmount = totalAmount - paidAmount;
                const paymentPercentage = totalAmount > 0 ? Math.round((paidAmount / totalAmount) * 100) : 0;
                
                // Check if overdue
                let status = customer.status || 'Active';
                let statusClass = status.toLowerCase();
                if (customer.dueDate) {
                    const dueDate = new Date(customer.dueDate);
                    const today = new Date();
                    if (dueDate < today && status === 'Active') {
                        status = 'Overdue';
                        statusClass = 'overdue';
                    }
                }
                
                tableHTML += `
                    <tr>
                        <td>
                            <span class="customer-id-badge">
                                ${customer.customerID || 'N/A'}
                            </span>
                        </td>
                        <td>
                            <div class="customer-info-cell">
                                <div class="customer-avatar-small">
                                    ${customer.customerPhoto ? 
                                        `<img src="${customer.customerPhoto}" alt="${customer.name}" 
                                              onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'><rect width=\'100\' height=\'100\' fill=\'%23f0f0f0\'/><text x=\'50\' y=\'50\' font-size=\'40\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23666\'>üë§</text></svg>'">` :
                                        '<div class="avatar-placeholder">üë§</div>'
                                    }
                                </div>
                                <div class="customer-details">
                                    <strong>${customer.name || 'Unnamed Customer'}</strong>
                                    <small>${customer.nicNumber ? 'NIC: ' + customer.nicNumber : ''}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="contact-info">
                                <div>üì± ${customer.phone || 'N/A'}</div>
                                <small>${customer.email || 'No email'}</small>
                            </div>
                        </td>
                        <td>
                            <strong>${customer.productName || 'N/A'}</strong>
                            <small>${customer.productCategory || ''}</small>
                        </td>
                        <td>
                            <div class="amount-info">
                                <div>Total: ‚Çπ${totalAmount.toFixed(2)}</div>
                                <div>Paid: ‚Çπ${paidAmount.toFixed(2)}</div>
                                <div>Due: ‚Çπ${remainingAmount.toFixed(2)}</div>
                            </div>
                        </td>
                        <td>
                            <div class="payment-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${paymentPercentage}%"></div>
                                </div>
                                <small>${paymentPercentage}% paid</small>
                            </div>
                        </td>
                        <td>
                            <span class="due-date ${isOverdue(customer.dueDate) ? 'overdue-date' : ''}">
                                ${formatDate(customer.dueDate)}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                ${status}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button onclick="viewCustomerDetails('${customer.id}')" 
                                        class="btn-action view" title="View Details">
                                    üëÅÔ∏è
                                </button>
                                <button onclick="downloadCustomerPDF('${customer.id}', '${customer.name}')" 
                                        class="btn-action download" title="Download PDF">
                                    üì•
                                </button>
                                <button onclick="sendReminder('${customer.id}')" 
                                        class="btn-action reminder" title="Send Reminder">
                                    üîî
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
            
            // Update counts
            document.getElementById('showingCount').textContent = 
                `${startIndex + 1}-${endIndex}`;
            document.getElementById('totalRecords').textContent = filteredCustomers.length;
        }
        
        function updatePagination() {
            const totalPages = Math.ceil(filteredCustomers.length / recordsPerPage);
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }
        
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayCustomers();
                updatePagination();
            }
        }
        
        function nextPage() {
            const totalPages = Math.ceil(filteredCustomers.length / recordsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayCustomers();
                updatePagination();
            }
        }
        
        // View customer details
        window.viewCustomerDetails = async function(customerDocID) {
            try {
                const db = firebase.firestore();
                const doc = await db.collection('customers').doc(customerDocID).get();
                
                if (!doc.exists) {
                    alert('Customer not found!');
                    return;
                }
                
                const customer = doc.data();
                currentCustomerID = customerDocID;
                
                // Format dates
                const dob = customer.dob ? formatDate(customer.dob) : 'Not provided';
                const startDate = customer.startDate ? formatDate(customer.startDate) : 'N/A';
                const dueDate = customer.dueDate ? formatDate(customer.dueDate) : 'N/A';
                const warrantyStart = customer.warrantyStart ? formatDate(customer.warrantyStart) : 'N/A';
                const warrantyEnd = customer.warrantyEnd ? formatDate(customer.warrantyEnd) : 'N/A';
                
                // Calculate payment info
                const totalAmount = parseFloat(customer.totalAmount) || 0;
                const paidAmount = parseFloat(customer.paidAmount) || 0;
                const remainingAmount = totalAmount - paidAmount;
                const paymentPercentage = totalAmount > 0 ? Math.round((paidAmount / totalAmount) * 100) : 0;
                
                const modalContent = `
                    <div class="customer-details-modal">
                        <!-- Header -->
                        <div class="details-header">
                            <div class="customer-photo-large">
                                ${customer.customerPhoto ? 
                                    `<img src="${customer.customerPhoto}" alt="${customer.name}">` :
                                    '<div class="avatar-large">üë§</div>'
                                }
                            </div>
                            <div class="customer-info-large">
                                <h4>${customer.name || 'Unnamed Customer'}</h4>
                                <p class="customer-id">ID: ${customer.customerID || 'N/A'}</p>
                                <p class="customer-status">
                                    Status: <span class="status-badge ${customer.status?.toLowerCase() || 'active'}">
                                        ${customer.status || 'Active'}
                                    </span>
                                </p>
                            </div>
                        </div>
                        
                        <!-- Tabs -->
                        <div class="details-tabs">
                            <button class="tab-btn active" data-tab="personal">Personal Info</button>
                            <button class="tab-btn" data-tab="product">Product Details</button>
                            <button class="tab-btn" data-tab="payment">Payment Info</button>
                            <button class="tab-btn" data-tab="warranty">Warranty</button>
                        </div>
                        
                        <!-- Tab Content -->
                        <div class="tab-content active" id="personal-tab">
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>Phone Number:</label>
                                    <span>${customer.phone || 'N/A'}</span>
                                </div>
                                <div class="info-item">
                                    <label>Email:</label>
                                    <span>${customer.email || 'Not provided'}</span>
                                </div>
                                <div class="info-item">
                                    <label>NIC Number:</label>
                                    <span>${customer.nicNumber || 'Not provided'}</span>
                                </div>
                                <div class="info-item">
                                    <label>Date of Birth:</label>
                                    <span>${dob}</span>
                                </div>
                                <div class="info-item full-width">
                                    <label>Address:</label>
                                    <span>${customer.address || 'Not provided'}</span>
                                </div>
                            </div>
                            
                            <div class="photo-section">
                                <h5>Customer Photos</h5>
                                <div class="photos-grid">
                                    <div class="photo-item">
                                        <label>Customer Photo:</label>
                                        ${customer.customerPhoto ? 
                                            `<img src="${customer.customerPhoto}" alt="Customer Photo" class="preview-image">` :
                                            '<p>No photo uploaded</p>'
                                        }
                                    </div>
                                    <div class="photo-item">
                                        <label>NIC Photo:</label>
                                        ${customer.nicPhoto ? 
                                            `<img src="${customer.nicPhoto}" alt="NIC Photo" class="preview-image">` :
                                            '<p>No NIC photo</p>'
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="product-tab">
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>Product Category:</label>
                                    <span>${customer.productCategory || 'N/A'}</span>
                                </div>
                                <div class="info-item">
                                    <label>Product Name:</label>
                                    <span>${customer.productName || 'N/A'}</span>
                                </div>
                                <div class="info-item">
                                    <label>Model Number:</label>
                                    <span>${customer.productModel || 'N/A'}</span>
                                </div>
                                <div class="info-item">
                                    <label>Serial Number:</label>
                                    <span>${customer.productSerial || 'N/A'}</span>
                                </div>
                                <div class="info-item full-width">
                                    <label>Description:</label>
                                    <span>${customer.productDescription || 'No description'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="payment-tab">
                            <div class="payment-summary-large">
                                <div class="summary-row">
                                    <span>Total Amount:</span>
                                    <strong>‚Çπ${totalAmount.toFixed(2)}</strong>
                                </div>
                                <div class="summary-row">
                                    <span>Down Payment:</span>
                                    <strong>‚Çπ${paidAmount.toFixed(2)}</strong>
                                </div>
                                <div class="summary-row">
                                    <span>Remaining Amount:</span>
                                    <strong class="due-amount">‚Çπ${remainingAmount.toFixed(2)}</strong>
                                </div>
                                <div class="summary-row">
                                    <span>Monthly Installment:</span>
                                    <strong>‚Çπ${parseFloat(customer.installmentAmount || 0).toFixed(2)}</strong>
                                </div>
                                <div class="summary-row">
                                    <span>Total Installments:</span>
                                    <strong>${customer.installmentCount || 0}</strong>
                                </div>
                                <div class="summary-row">
                                    <span>Start Date:</span>
                                    <strong>${startDate}</strong>
                                </div>
                                <div class="summary-row">
                                    <span>Next Due Date:</span>
                                    <strong class="${isOverdue(customer.dueDate) ? 'overdue-date' : ''}">
                                        ${dueDate}
                                    </strong>
                                </div>
                                <div class="summary-row">
                                    <span>Payment Progress:</span>
                                    <div class="progress-container">
                                        <div class="progress-bar-large">
                                            <div class="progress-fill-large" style="width: ${paymentPercentage}%"></div>
                                        </div>
                                        <span>${paymentPercentage}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="warranty-tab">
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>Warranty Type:</label>
                                    <span>${customer.warrantyType || 'Not specified'}</span>
                                </div>
                                <div class="info-item">
                                    <label>Warranty Period:</label>
                                    <span>${customer.warrantyPeriod || 'Not specified'}</span>
                                </div>
                                <div class="info-item">
                                    <label>Start Date:</label>
                                    <span>${warrantyStart}</span>
                                </div>
                                <div class="info-item">
                                    <label>End Date:</label>
                                    <span>${warrantyEnd}</span>
                                </div>
                                <div class="info-item full-width">
                                    <label>Terms & Conditions:</label>
                                    <span>${customer.warrantyTerms || 'No terms specified'}</span>
                                </div>
                                <div class="info-item full-width">
                                    <label>Guarantee Card:</label>
                                    <span>${customer.guaranteeCard || 'No guarantee card details'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Info -->
                        <div class="additional-info">
                            <h5>Additional Information</h5>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>Reference By:</label>
                                    <span>${customer.referenceBy || 'Not specified'}</span>
                                </div>
                                <div class="info-item">
                                    <label>Sales Person:</label>
                                    <span>${customer.salesPerson || 'Not specified'}</span>
                                </div>
                                <div class="info-item full-width">
                                    <label>Remarks:</label>
                                    <span>${customer.remarks || 'No remarks'}</span>
                                </div>
                                <div class="info-item">
                                    <label>Created On:</label>
                                    <span>${formatDate(customer.createdAt)}</span>
                                </div>
                                <div class="info-item">
                                    <label>Last Updated:</label>
                                    <span>${formatDate(customer.updatedAt)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('customerDetails').innerHTML = modalContent;
                document.getElementById('customerModal').style.display = 'block';
                
                // Setup tab switching
                setupTabs();
                
            } catch (error) {
                console.error('Error loading customer details:', error);
                alert('Failed to load customer details: ' + error.message);
            }
        };
        
        function setupTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Remove active class from all
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    document.getElementById(tabId + '-tab').classList.add('active');
                });
            });
        }
        
        function closeModal() {
            document.getElementById('customerModal').style.display = 'none';
            currentCustomerID = null;
        }
        
        // Export to CSV
        async function exportToCSV() {
            try {
                if (filteredCustomers.length === 0) {
                    alert('No data to export!');
                    return;
                }
                
                let csvContent = 'Customer ID,Name,Phone,Email,Product,Total Amount,Paid Amount,Remaining Amount,Installments,Start Date,Due Date,Status,NIC Number,Address\n';
                
                filteredCustomers.forEach(customer => {
                    const total = parseFloat(customer.totalAmount) || 0;
                    const paid = parseFloat(customer.paidAmount) || 0;
                    const remaining = total - paid;
                    
                    csvContent += `"${customer.customerID || ''}","${customer.name || ''}","${customer.phone || ''}","${customer.email || ''}","${customer.productName || ''}",${total},${paid},${remaining},${customer.installmentCount || 0},"${customer.startDate || ''}","${customer.dueDate || ''}","${customer.status || ''}","${customer.nicNumber || ''}","${customer.address || ''}"\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const date = new Date().toISOString().split('T')[0];
                
                a.href = url;
                a.download = `customers_${date}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                document.getElementById('tableMessage').innerHTML = `
                    <div class="message success">
                        ‚úÖ CSV exported successfully with ${filteredCustomers.length} records
                    </div>
                `;
                
            } catch (error) {
                console.error('Export error:', error);
                alert('Export failed: ' + error.message);
            }
        }
        
        // Generate individual customer PDF
        window.downloadCustomerPDF = async function(customerDocID, customerName) {
            try {
                document.getElementById('tableMessage').innerHTML = 
                    '<div class="message info">Generating PDF... Please wait</div>';
                
                const db = firebase.firestore();
                const doc = await db.collection('customers').doc(customerDocID).get();
                
                if (!doc.exists) {
                    throw new Error('Customer not found');
                }
                
                const customer = doc.data();
                await generatePDF(customer, customerName);
                
            } catch (error) {
                console.error('PDF generation error:', error);
                document.getElementById('tableMessage').innerHTML = `
                    <div class="message error">
                        ‚ùå PDF generation failed: ${error.message}
                    </div>
                `;
            }
        };
        
        // Generate PDF function
        async function generatePDF(customer, customerName = 'Customer') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Add logo/header
            doc.setFillColor(41, 128, 185);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text('INSTALLMENT RECEIPT', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text('Customer Account Details', 105, 28, { align: 'center' });
            
            // Reset text color
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            
            let yPos = 50;
            
            // Customer ID and Date
            doc.setFont(undefined, 'bold');
            doc.text(`Customer ID: ${customer.customerID || 'N/A'}`, 20, yPos);
            doc.text(`Date: ${new Date().toLocaleDateString('en-IN')}`, 150, yPos);
            doc.setFont(undefined, 'normal');
            yPos += 10;
            
            // Line separator
            doc.setDrawColor(200, 200, 200);
            doc.line(20, yPos, 190, yPos);
            yPos += 15;
            
            // Customer Information Section
            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.text('CUSTOMER INFORMATION', 20, yPos);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            yPos += 10;
            
            // Customer details in two columns
            const col1 = 20;
            const col2 = 110;
            
            doc.text(`Name: ${customer.name || 'N/A'}`, col1, yPos);
            doc.text(`Phone: ${customer.phone || 'N/A'}`, col2, yPos);
            yPos += 7;
            
            doc.text(`Email: ${customer.email || 'N/A'}`, col1, yPos);
            doc.text(`NIC: ${customer.nicNumber || 'N/A'}`, col2, yPos);
            yPos += 7;
            
            doc.text(`Address: ${customer.address || 'N/A'}`, col1, yPos);
            yPos += 10;
            
            // Product Information
            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.text('PRODUCT INFORMATION', 20, yPos);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            yPos += 10;
            
            doc.text(`Product: ${customer.productName || 'N/A'}`, col1, yPos);
            doc.text(`Category: ${customer.productCategory || 'N/A'}`, col2, yPos);
            yPos += 7;
            
            doc.text(`Model: ${customer.productModel || 'N/A'}`, col1, yPos);
            doc.text(`Serial: ${customer.productSerial || 'N/A'}`, col2, yPos);
            yPos += 10;
            
            // Payment Details
            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.text('PAYMENT DETAILS', 20, yPos);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            yPos += 10;
            
            const totalAmount = parseFloat(customer.totalAmount) || 0;
            const paidAmount = parseFloat(customer.paidAmount) || 0;
            const remainingAmount = totalAmount - paidAmount;
            
            doc.text(`Total Amount: ‚Çπ${totalAmount.toFixed(2)}`, col1, yPos);
            doc.text(`Down Payment: ‚Çπ${paidAmount.toFixed(2)}`, col2, yPos);
            yPos += 7;
            
            doc.text(`Remaining Amount: ‚Çπ${remainingAmount.toFixed(2)}`, col1, yPos);
            doc.text(`Monthly Installment: ‚Çπ${parseFloat(customer.installmentAmount || 0).toFixed(2)}`, col2, yPos);
            yPos += 7;
            
            doc.text(`Total Installments: ${customer.installmentCount || 0}`, col1, yPos);
            doc.text(`Next Due Date: ${formatDate(customer.dueDate)}`, col2, yPos);
            yPos += 10;
            
            // Warranty Information
            if (customer.warrantyType) {
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text('WARRANTY INFORMATION', 20, yPos);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                yPos += 10;
                
                doc.text(`Type: ${customer.warrantyType}`, col1, yPos);
                doc.text(`Period: ${customer.warrantyPeriod || 'N/A'}`, col2, yPos);
                yPos += 7;
                
                doc.text(`Start Date: ${formatDate(customer.warrantyStart)}`, col1, yPos);
                doc.text(`End Date: ${formatDate(customer.warrantyEnd)}`, col2, yPos);
                yPos += 10;
            }
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('This is a computer generated receipt. No signature required.', 105, 280, { align: 'center' });
            doc.text('Generated on: ' + new Date().toLocaleString('en-IN'), 105, 285, { align: 'center' });
            
            // Save PDF
            const fileName = `Customer_${customer.customerID || customerName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            document.getElementById('tableMessage').innerHTML = `
                <div class="message success">
                    ‚úÖ PDF generated and downloaded successfully: ${fileName}
                </div>
            `;
        }
        
        function generateBulkPDF() {
            if (filteredCustomers.length === 0) {
                alert('No customers to generate PDF for!');
                return;
            }
            
            if (filteredCustomers.length > 10) {
                if (!confirm(`You are about to generate ${filteredCustomers.length} PDF files. This may take a while. Continue?`)) {
                    return;
                }
            }
            
            document.getElementById('tableMessage').innerHTML = 
                '<div class="message info">Generating bulk PDFs... This may take a moment</div>';
            
            // Generate first PDF as example
            if (filteredCustomers.length > 0) {
                generatePDF(filteredCustomers[0], filteredCustomers[0].name);
            }
        }
        
        function generateCustomerPDF() {
            if (currentCustomerID) {
                const customerName = document.querySelector('.customer-info-large h4').textContent;
                downloadCustomerPDF(currentCustomerID, customerName);
            }
        }
        
        function editCustomer() {
            if (currentCustomerID) {
                alert(`Edit customer with ID: ${currentCustomerID}\n\nThis feature will open edit form.`);
                // window.location.href = `edit-customer.html?id=${currentCustomerID}`;
            }
        }
        
        window.sendReminder = function(customerID) {
            alert(`Reminder sent for customer ${customerID}\n\nThis feature can be extended to send SMS/Email reminders.`);
        };
        
        // Helper functions
        function isOverdue(dateString) {
            if (!dateString) return false;
            const dueDate = new Date(dateString);
            const today = new Date();
            return dueDate < today;
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('customerModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
