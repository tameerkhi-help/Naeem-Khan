<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Installment System</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.8.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.8.4/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.8.4/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <div class="logo-small">üí∞</div>
                <div>
                    <h1>Installment Management</h1>
                    <p class="admin-email" id="adminEmail">Loading...</p>
                </div>
            </div>
            
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link active">
                    <span class="nav-icon">üìä</span>
                    Dashboard
                </a>
                <a href="add-customer.html" class="nav-link">
                    <span class="nav-icon">‚ûï</span>
                    Add Customer
                </a>
                <a href="view-customers.html" class="nav-link">
                    <span class="nav-icon">üë•</span>
                    View Customers
                </a>
                <a href="reports.html" class="nav-link">
                    <span class="nav-icon">üìà</span>
                    Reports
                </a>
                <button id="logoutBtn" class="btn btn-logout">
                    <span class="nav-icon">üö™</span>
                    Logout
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Welcome Header -->
            <div class="welcome-section">
                <h2>Welcome to Dashboard</h2>
                <p>Manage your installment customers efficiently</p>
                <div class="current-time" id="currentTime"></div>
            </div>
            
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon total-customers">üë•</div>
                    <div class="stat-info">
                        <h3>Total Customers</h3>
                        <p id="totalCustomers" class="stat-number">0</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon total-revenue">üí∞</div>
                    <div class="stat-info">
                        <h3>Total Revenue</h3>
                        <p id="totalRevenue" class="stat-number">‚Çπ0</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon pending">‚è∞</div>
                    <div class="stat-info">
                        <h3>Pending Amount</h3>
                        <p id="pendingAmount" class="stat-number">‚Çπ0</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon active">‚úÖ</div>
                    <div class="stat-info">
                        <h3>Active Accounts</h3>
                        <p id="activeAccounts" class="stat-number">0</p>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="section-card">
                <h3 class="section-title">Quick Actions</h3>
                <div class="quick-actions-grid">
                    <a href="add-customer.html" class="action-card">
                        <div class="action-icon">‚ûï</div>
                        <div class="action-content">
                            <h4>Add New Customer</h4>
                            <p>Create new installment account with photos</p>
                        </div>
                    </a>
                    
                    <a href="view-customers.html" class="action-card">
                        <div class="action-icon">üîç</div>
                        <div class="action-content">
                            <h4>Search Customers</h4>
                            <p>Find customers by ID, name, or phone</p>
                        </div>
                    </a>
                    
                    <a href="view-customers.html" class="action-card">
                        <div class="action-icon">üì•</div>
                        <div class="action-content">
                            <h4>Download Reports</h4>
                            <p>Export customer data to PDF</p>
                        </div>
                    </a>
                    
                    <a href="reports.html" class="action-card">
                        <div class="action-icon">üìä</div>
                        <div class="action-content">
                            <h4>View Analytics</h4>
                            <p>Business insights and reports</p>
                        </div>
                    </a>
                </div>
            </div>
            
            <!-- Recent Customers -->
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">Recent Customers</h3>
                    <a href="view-customers.html" class="btn-view-all">View All ‚Üí</a>
                </div>
                
                <div id="recentCustomers" class="recent-customers-list">
                    <div class="loading-placeholder">
                        <div class="loader"></div>
                        <p>Loading recent customers...</p>
                    </div>
                </div>
            </div>
            
            <!-- System Status -->
            <div class="system-status">
                <div class="status-item">
                    <span class="status-label">Database:</span>
                    <span class="status-value online">Connected</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Storage:</span>
                    <span class="status-value online">Ready</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Last Updated:</span>
                    <span id="lastUpdated" class="status-value">Just now</span>
                </div>
            </div>
        </div>
    </main>
    
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const adminEmail = document.getElementById('adminEmail');
            const logoutBtn = document.getElementById('logoutBtn');
            const currentTime = document.getElementById('currentTime');
            
            // Update current time
            function updateTime() {
                const now = new Date();
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                };
                currentTime.textContent = now.toLocaleDateString('en-IN', options);
            }
            updateTime();
            setInterval(updateTime, 1000);
            
            // Check authentication
            firebase.auth().onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'index.html';
                } else {
                    adminEmail.textContent = user.email;
                    await loadDashboardData();
                }
            });
            
            // Logout
            logoutBtn.addEventListener('click', function() {
                firebase.auth().signOut().then(() => {
                    window.location.href = 'index.html';
                }).catch(error => {
                    alert('Logout error: ' + error.message);
                });
            });
            
            // Load dashboard data
            async function loadDashboardData() {
                try {
                    const snapshot = await firebase.firestore().collection('customers').get();
                    
                    if (snapshot.empty) {
                        updateStats(0, 0, 0, 0);
                        showNoCustomers();
                        return;
                    }
                    
                    let totalCustomers = 0;
                    let totalRevenue = 0;
                    let totalPending = 0;
                    let activeAccounts = 0;
                    const customers = [];
                    
                    snapshot.forEach(doc => {
                        const customer = doc.data();
                        customers.push({ id: doc.id, ...customer });
                        
                        totalCustomers++;
                        totalRevenue += parseFloat(customer.totalAmount) || 0;
                        
                        const paid = parseFloat(customer.paidAmount) || 0;
                        const total = parseFloat(customer.totalAmount) || 0;
                        totalPending += (total - paid);
                        
                        if (customer.status !== 'Completed' && (total - paid) > 0) {
                            activeAccounts++;
                        }
                    });
                    
                    updateStats(totalCustomers, totalRevenue, totalPending, activeAccounts);
                    displayRecentCustomers(customers.slice(-5).reverse());
                    document.getElementById('lastUpdated').textContent = 'Just now';
                    
                } catch (error) {
                    console.error('Dashboard error:', error);
                    showError('Failed to load dashboard data');
                }
            }
            
            // Update stats
            function updateStats(total, revenue, pending, active) {
                document.getElementById('totalCustomers').textContent = total;
                document.getElementById('totalRevenue').textContent = '‚Çπ' + revenue.toFixed(2);
                document.getElementById('pendingAmount').textContent = '‚Çπ' + pending.toFixed(2);
                document.getElementById('activeAccounts').textContent = active;
            }
            
            // Display recent customers
            function displayRecentCustomers(customers) {
                const container = document.getElementById('recentCustomers');
                
                if (customers.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>No customers found. Add your first customer!</p>
                            <a href="add-customer.html" class="btn btn-primary">Add Customer</a>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                customers.forEach(customer => {
                    html += `
                        <div class="recent-customer-item">
                            <div class="customer-avatar">
                                ${customer.customerPhoto ? 
                                    `<img src="${customer.customerPhoto}" alt="${customer.name}">` : 
                                    '<div class="avatar-placeholder">üë§</div>'
                                }
                            </div>
                            <div class="customer-info">
                                <h4>${customer.name || 'No Name'}</h4>
                                <p class="customer-id">ID: ${customer.customerID || 'N/A'}</p>
                                <p class="customer-phone">üì± ${customer.phone || 'No Phone'}</p>
                            </div>
                            <div class="customer-status">
                                <span class="status-badge ${(customer.status || 'Active').toLowerCase()}">
                                    ${customer.status || 'Active'}
                                </span>
                                <p class="customer-amount">‚Çπ${parseFloat(customer.totalAmount || 0).toFixed(2)}</p>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            function showNoCustomers() {
                const container = document.getElementById('recentCustomers');
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No customers yet. Start by adding your first customer!</p>
                        <a href="add-customer.html" class="btn btn-primary">Add First Customer</a>
                    </div>
                `;
            }
            
            function showError(message) {
                const container = document.getElementById('recentCustomers');
                container.innerHTML = `
                    <div class="error-state">
                        <p>‚ùå ${message}</p>
                        <button onclick="loadDashboardData()" class="btn btn-secondary">Retry</button>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
