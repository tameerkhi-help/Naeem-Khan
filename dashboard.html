<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Installment System</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.8.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.8.4/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.8.4/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Navigation Menu -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>Installment Management</h1>
                <p class="admin-email" id="adminEmail">Loading...</p>
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link active">Dashboard</a>
                <a href="add-customer.html" class="nav-link">Add Customer</a>
                <a href="view-customers.html" class="nav-link">View Customers</a>
                <a href="reports.html" class="nav-link">Reports</a>
                <button id="logoutBtn" class="btn-logout">Logout</button>
            </div>
        </div>
    </nav>
    
    <!-- Main Dashboard Content -->
    <main class="container">
        <div class="dashboard-header">
            <h2>Admin Dashboard</h2>
            <p>Complete installment management system</p>
        </div>
        
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Customers</h3>
                <p id="totalCustomers" class="stat-number">0</p>
            </div>
            <div class="stat-card">
                <h3>Active Installments</h3>
                <p id="activeInstallments" class="stat-number">0</p>
            </div>
            <div class="stat-card">
                <h3>Pending Amount</h3>
                <p id="pendingAmount" class="stat-number">₹0</p>
            </div>
            <div class="stat-card">
                <h3>Received Amount</h3>
                <p id="receivedAmount" class="stat-number">₹0</p>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <h3>Quick Actions</h3>
            <div class="actions-grid">
                <a href="add-customer.html" class="action-card">
                    <h4>Add New Customer</h4>
                    <p>Create new installment account</p>
                </a>
                <a href="view-customers.html" class="action-card">
                    <h4>View All Customers</h4>
                    <p>See complete customer list</p>
                </a>
                <a href="view-customers.html" class="action-card">
                    <h4>Download Data</h4>
                    <p>Export to CSV/Excel</p>
                </a>
                <a href="reports.html" class="action-card">
                    <h4>View Reports</h4>
                    <p>Monthly/yearly reports</p>
                </a>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="recent-activity">
            <h3>Recent Customers</h3>
            <div id="recentCustomers" class="activity-list">
                <p>Loading recent customers...</p>
            </div>
        </div>
    </main>
    
    <script src="script.js"></script>
    <script>
        // Dashboard page specific code
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            firebase.auth().onAuthStateChanged((user) => {
                if (!user) {
                    window.location.href = 'index.html';
                } else {
                    document.getElementById('adminEmail').textContent = user.email;
                    loadDashboardStats();
                }
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                firebase.auth().signOut().then(() => {
                    window.location.href = 'index.html';
                });
            });
            
            // Load dashboard statistics
            async function loadDashboardStats() {
                try {
                    const db = firebase.firestore();
                    const snapshot = await db.collection('customers').get();
                    const customers = [];
                    
                    snapshot.forEach(doc => {
                        customers.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Calculate statistics
                    const totalCustomers = customers.length;
                    const activeInstallments = customers.filter(c => {
                        const dueDate = new Date(c.dueDate);
                        const today = new Date();
                        return dueDate > today;
                    }).length;
                    
                    const totalAmount = customers.reduce((sum, c) => sum + (parseFloat(c.totalAmount) || 0), 0);
                    const paidAmount = customers.reduce((sum, c) => sum + (parseFloat(c.paidAmount) || 0), 0);
                    const pendingAmount = totalAmount - paidAmount;
                    
                    // Update UI
                    document.getElementById('totalCustomers').textContent = totalCustomers;
                    document.getElementById('activeInstallments').textContent = activeInstallments;
                    document.getElementById('pendingAmount').textContent = `₹${pendingAmount.toFixed(2)}`;
                    document.getElementById('receivedAmount').textContent = `₹${paidAmount.toFixed(2)}`;
                    
                    // Show recent customers
                    const recent = customers.slice(-5).reverse();
                    const recentHtml = recent.map(customer => `
                        <div class="activity-item">
                            <strong>${customer.name}</strong>
                            <span>Product: ${customer.product}</span>
                            <span>Paid: ₹${customer.paidAmount}</span>
                            <span>Due: ${customer.dueDate}</span>
                        </div>
                    `).join('');
                    
                    document.getElementById('recentCustomers').innerHTML = recentHtml || '<p>No customers found</p>';
                    
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            }
        });
    </script>
</body>
</html>
