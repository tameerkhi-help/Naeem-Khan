<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Customer | Installment System</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.8.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.8.4/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.8.4/firebase-firestore-compat.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>Add New Customer</h1>
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="add-customer.html" class="nav-link active">Add Customer</a>
                <a href="view-customers.html" class="nav-link">View Customers</a>
                <a href="reports.html" class="nav-link">Reports</a>
                <button id="logoutBtn" class="btn-logout">Logout</button>
            </div>
        </div>
    </nav>
    
    <main class="container">
        <div class="page-header">
            <h2>Add New Installment Customer</h2>
            <p>Fill all details for new installment account</p>
        </div>
        
        <div class="form-container">
            <form id="customerForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="name">Customer Full Name *</label>
                        <input type="text" id="name" placeholder="John Smith" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" placeholder="customer@example.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">Phone Number *</label>
                        <input type="tel" id="phone" placeholder="9876543210" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="address">Address</label>
                        <textarea id="address" placeholder="Full address" rows="2"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="product">Product Name *</label>
                        <input type="text" id="product" placeholder="LED TV, Refrigerator, etc." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="productPrice">Product Price (₹) *</label>
                        <input type="number" id="productPrice" placeholder="25000" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="downPayment">Down Payment (₹) *</label>
                        <input type="number" id="downPayment" placeholder="5000" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="installmentAmount">Monthly Installment (₹) *</label>
                        <input type="number" id="installmentAmount" placeholder="2000" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="installmentCount">Total Installments (Months) *</label>
                        <input type="number" id="installmentCount" placeholder="12" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="startDate">Installment Start Date *</label>
                        <input type="date" id="startDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="dueDate">Next Due Date *</label>
                        <input type="date" id="dueDate" required>
                    </div>
                </div>
                
                <div class="form-summary">
                    <h3>Payment Summary</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <span>Total Amount:</span>
                            <strong id="totalDisplay">₹0</strong>
                        </div>
                        <div class="summary-item">
                            <span>Down Payment:</span>
                            <strong id="downDisplay">₹0</strong>
                        </div>
                        <div class="summary-item">
                            <span>Remaining Amount:</span>
                            <strong id="remainingDisplay">₹0</strong>
                        </div>
                        <div class="summary-item">
                            <span>Monthly Installment:</span>
                            <strong id="monthlyDisplay">₹0</strong>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-submit">Save Customer Record</button>
                    <button type="button" class="btn-cancel" onclick="window.location.href='dashboard.html'">
                        Cancel
                    </button>
                </div>
            </form>
            
            <div id="formMessage" class="message"></div>
        </div>
    </main>
    
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            firebase.auth().onAuthStateChanged((user) => {
                if (!user) {
                    window.location.href = 'index.html';
                }
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                firebase.auth().signOut().then(() => {
                    window.location.href = 'index.html';
                });
            });
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            
            // Calculate next month for due date
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            document.getElementById('dueDate').value = nextMonth.toISOString().split('T')[0];
            
            // Calculate summary automatically
            function calculateSummary() {
                const price = parseFloat(document.getElementById('productPrice').value) || 0;
                const down = parseFloat(document.getElementById('downPayment').value) || 0;
                const monthly = parseFloat(document.getElementById('installmentAmount').value) || 0;
                const months = parseInt(document.getElementById('installmentCount').value) || 0;
                
                const total = price;
                const remaining = total - down;
                const calculatedMonthly = remaining / (months || 1);
                
                document.getElementById('totalDisplay').textContent = `₹${total.toFixed(2)}`;
                document.getElementById('downDisplay').textContent = `₹${down.toFixed(2)}`;
                document.getElementById('remainingDisplay').textContent = `₹${remaining.toFixed(2)}`;
                document.getElementById('monthlyDisplay').textContent = `₹${calculatedMonthly.toFixed(2)}`;
                
                // Auto-update installment amount if not set
                if (!document.getElementById('installmentAmount').value && months > 0) {
                    document.getElementById('installmentAmount').value = calculatedMonthly.toFixed(2);
                }
            }
            
            // Add event listeners for auto-calculation
            ['productPrice', 'downPayment', 'installmentCount'].forEach(id => {
                document.getElementById(id).addEventListener('input', calculateSummary);
            });
            
            // Initial calculation
            calculateSummary();
            
            // Form submission
            document.getElementById('customerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formMessage = document.getElementById('formMessage');
                formMessage.textContent = 'Saving customer data...';
                formMessage.className = 'message info';
                
                try {
                    const db = firebase.firestore();
                    const customerData = {
                        name: document.getElementById('name').value,
                        email: document.getElementById('email').value,
                        phone: document.getElementById('phone').value,
                        address: document.getElementById('address').value,
                        product: document.getElementById('product').value,
                        totalAmount: parseFloat(document.getElementById('productPrice').value),
                        downPayment: parseFloat(document.getElementById('downPayment').value),
                        installmentAmount: parseFloat(document.getElementById('installmentAmount').value),
                        installmentCount: parseInt(document.getElementById('installmentCount').value),
                        startDate: document.getElementById('startDate').value,
                        dueDate: document.getElementById('dueDate').value,
                        paidAmount: parseFloat(document.getElementById('downPayment').value),
                        remainingAmount: parseFloat(document.getElementById('productPrice').value) - 
                                       parseFloat(document.getElementById('downPayment').value),
                        status: 'Active',
                        createdDate: new Date().toISOString(),
                        lastUpdated: new Date().toISOString()
                    };
                    
                    // Save to Firestore
                    await db.collection('customers').add(customerData);
                    
                    formMessage.textContent = 'Customer saved successfully! Redirecting...';
                    formMessage.className = 'message success';
                    
                    // Clear form
                    document.getElementById('customerForm').reset();
                    
                    // Redirect after 2 seconds
                    setTimeout(() => {
                        window.location.href = 'view-customers.html';
                    }, 2000);
                    
                } catch (error) {
                    formMessage.textContent = 'Error: ' + error.message;
                    formMessage.className = 'message error';
                }
            });
        });
    </script>
</body>
</html>
